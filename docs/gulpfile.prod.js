"use strict";var gulp=require("gulp"),sass=require("gulp-sass"),postcss=require("gulp-postcss"),cssnano=require("gulp-cssnano"),rename=require("gulp-rename"),browserSyns=require("browser-sync"),pug=require("gulp-pug"),imageMin=require("gulp-imagemin"),spritesmith=require("gulp.spritesmith"),merge=require("merge-stream"),svgSprite=require("gulp-svg-sprites"),filter=require("filter"),webpack=require("webpack-stream"),webpackConfig=require("./webpack.config.js"),gutil=require("gulp-util"),getData=require("jade-get-data")("app/data"),concat=require("gulp-concat"),font2css=require("gulp-font2css").default,errorHandler=require("gulp-error-handle"),clean=require("gulp-clean"),dirDist="./dist/",dirDeploy="./docs/",dirApp="./app/",_={dist:{images:dirDist+"images/",fonts:dirDist+"fonts/",js:dirDist+"js/",css:dirDist+"css/",out:"../"},fonts:{dir:dirApp+"static/fonts/",select:"**/*.{otf,ttf,woff,woff2}"},minImg:{dir:dirApp+"static/images/",select:"*.*"},sprite:{png:{dir:dirApp+"static/images/pngSprite/",select:"*.png"},svg:{dir:dirApp+"static/images/svgSprite/",select:"*.svg"}},pug:{dir:dirApp+"templates/",data:{dir:dirApp+"data/",select:"**/*.json"},select:{pages:"pages/*.pug",all:"**/*.pug"}},style:{base:dirApp+"scss/base/",dir:dirApp+"scss/",select:{conv:"*.scss",all:"**/*.scss"}},js:{libs:["node_modules/jquery/src/jquery.js","node_modules/fancybox/dist/js/jquery.fancybox.js","node_modules/swiper/js/swiper.js"],select:"**/*.js",dir:dirApp+"scripts/",start:"index.js"}};gulp.task("scss",function(){return gulp.src(_.style.dir+_.style.select.conv).pipe(sass({outputStyle:"compressed"})).pipe(postcss([require("autoprefixer"),require("postcss-discard-comments"),require("postcss-import")])).pipe(cssnano({zIndex:!1})).pipe(rename({suffix:".min"})).pipe(gulp.dest(_.dist.css)).pipe(browserSyns.reload({stream:!0}))});var logError=function(){this.emit("end")},jsInProccess=!1;gulp.task("js",function(s){jsInProccess||(jsInProccess=!0,gulp.src(_.js.dir+_.js.start).pipe(webpack(webpackConfig)).pipe(errorHandler(logError)).pipe(gulp.dest(_.dist.js)),jsInProccess=!1,s())}),gulp.task("images",function(){return gulp.src(_.minImg.dir+_.minImg.select).pipe(imageMin()).pipe(gulp.dest(_.dist.images)).pipe(browserSyns.reload({stream:!0}))}),gulp.task("pngSprite",function(){var s=gulp.src(_.sprite.png.dir+_.sprite.png.select).pipe(spritesmith({imgName:"../images/sprite.png",cssName:"pngSprite.scss",cssFormat:"scss",algorithm:"top-down",cssVarMap:function(s){s.name="icon-"+s.name}})),e=s.css.pipe(gulp.dest(_.style.base)),p=s.img.pipe(gulp.dest(_.dist.images));return merge(p,e)}),gulp.task("svgSprite",function(){return gulp.src(_.sprite.svg.dir+_.sprite.svg.select).pipe(svgSprite({selector:"svg-%f",common:"svg-icon",cssFile:_.dist.out+_.style.base+"svgSprite.scss",svg:{sprite:"images/sprite.svg"},preview:!1})).pipe(gulp.dest(dirDist))}),gulp.task("font2css",function(){return gulp.src(_.fonts.dir+_.fonts.select).pipe(font2css()).pipe(concat("fonts.css")).pipe(gulp.dest(_.style.base))}),gulp.task("pug",function(){return gulp.src(_.pug.dir+_.pug.select.pages).pipe(pug({data:{getData:getData},pretty:!0,wrapLineLength:120,maxPreserveNewlines:50})).pipe(gulp.dest(dirDist)).pipe(browserSyns.reload({stream:!0}))}),gulp.task("watch",function(){gulp.watch(_.style.dir+_.style.select.all,gulp.parallel("scss")),gulp.watch(_.js.dir+_.js.select,gulp.parallel("js")),gulp.watch(_.pug.dir+_.pug.select.all,gulp.parallel("pug")),gulp.watch(_.pug.data.dir+_.pug.data.select,gulp.parallel("pug")),gulp.watch(_.minImg.dir+_.minImg.select,gulp.parallel("images")),gulp.watch(_.sprite.png.dir+_.sprite.png.select,gulp.parallel("pngSprite")),gulp.watch(_.sprite.svg.dir+_.sprite.svg.select,gulp.parallel("svgSprite")),gulp.watch(_.fonts.dir+_.fonts.select,gulp.parallel("font2css"))}),gulp.task("browser-sync",function(){browserSyns.init({server:{baseDir:dirDist}})}),gulp.task("clear-build",function(){return gulp.src(dirDist,{read:!1,allowEmpty:!0}).pipe(clean())}),gulp.task("copy-deploy",function(){return gulp.src(dirDist+"**/*").pipe(gulp.dest(dirDeploy))}),gulp.task("clear-deploy",function(){return gulp.src(dirDeploy,{read:!1,allowEmpty:!0}).pipe(clean())}),gulp.task("pre-scss",gulp.parallel("pngSprite","svgSprite","font2css")),gulp.task("styles",gulp.series("pre-scss","scss")),gulp.task("after-clean",gulp.parallel("styles","js","pug","images")),gulp.task("after-build",gulp.parallel("browser-sync","watch")),gulp.task("build",gulp.series("clear-build","after-clean")),gulp.task("dev",gulp.series("copy-deploy","build","after-build")),gulp.task("default",gulp.parallel("dev")),gulp.task("deploy",gulp.series("clear-deploy","build","copy-deploy"));